<?xml version="1.0" encoding="UTF-8" ?>
<dataConfig>
    <dataSource name="KuorumMongo" type="MongoDataSource" database="Kuorum" host="localhost" port="27017"/>
    <propertyWriter dateFormat="yyyy-MM-dd'T'HH:mm:ss.SSS'Z'" type="SimplePropertiesWriter" />

    <document name="kuorum">

        <entity name="kuorumUser"
                processor="MongoEntityProcessor"
                query="{'authorities.authority':{$ne:'ROLE_INCOMPLETE_USER'}, alias:{$exists:1}}"
		deltaImportQuery="{'_id':{$oid:'${dih.delta._id}'}}"
                deltaQuery="{lastUpdated:{$gt:{$date:'${dih.last_index_time}'}}} "
                collection="kuorumUser"
                datasource="KuorumMongo"
                transformer="script:transformKuorumUser" >
        </entity>
    </document>

<script><![CDATA[
        function transformKuorumUser(row){
            row.put('id', row.get('_id'));
            row.put('name', getFullName(row));
            row.put('type', "KUORUM_USER");
            row.put('dateCreated', row.get('dateCreated'));
	        row.put('hashtag', row.get('alias'));
	        getTags(row);
            getRegionNameFromUser(row);
            getAvatar(row);
            getRole(row);
            getGender(row);
            getPoliticianInfo(row);
            row.put('text', row.get('bio'));
            row.put('kuorumRelevance', row.get('relevance'));
            row.put('numberPeopleInterestedFor', 100); //TODO: recover from other collection
            return row;
        }

    function getFullName(kuorumUser){
        var fullName = kuorumUser.get('name');
        if (kuorumUser.get('surname') != null){
            var fullName = kuorumUser.get('name') +' '+ kuorumUser.get('surname');
        }
        fullName = fullName.trim();
        return fullName;
    }

    function getPoliticianInfo(kuorumUser){
        var professionalDetailsField = "professionalDetails";
        if (kuorumUser.get(professionalDetailsField) !=null){
            var politicalPartyName = kuorumUser.get(professionalDetailsField).get('politicalParty')
            if (politicalPartyName!= null){kuorumUser.put('politicalPartyName',politicalPartyName)}
		}
    }

	function getTags(kuorumUser){
		if (kuorumUser.get('ideology') !=null && kuorumUser.get('ideology').get('supportedCauses')){
			kuorumUser.put('tags',kuorumUser.get('ideology').get('supportedCauses'))
		}else{
			kuorumUser.put('tags',[])
		}
	}

        function getRole(kuorumUser){
            if (kuorumUser.get('gamification') != null && kuorumUser.get('gamification').get('activeRole')!= null){
                kuorumUser.put('role',kuorumUser.get('gamification').get('activeRole'))
            }else{
                kuorumUser.put('role','ROLE_DEFAULT')
            }
        }
        function getGender(kuorumUser){
            if (kuorumUser.get('personalData') != null && kuorumUser.get('personalData').get('gender') != null){
                kuorumUser.put("gender", kuorumUser.get('personalData').get('gender'));
            }else{
                kuorumUser.put("gender", "FEMALE");
            }
        }

        function getAvatar(kuorumUser){
            if (kuorumUser.get('avatar') != null){
                kuorumUser.put("urlImage",kuorumUser.get('avatar').get('url'));
            }
        }
	function getRegionNameFromUser(kuorumUser){
		var regionName ="";
		var regionIso = "";
		var regionIso3166_2Length = 0;

		var constituencyIso = "";
		var constituencyIsoLength = 0;
		if (kuorumUser.get('personalData') == null || kuorumUser.get('personalData').get('province') == null){
            //Usuarios de antigua web que se indexen
            regionName = "Unknown"
            regionIso = "NoValid"
	        regionIso3166_2Length = 0
        }else{
            regionName = kuorumUser.get('personalData').get('province')
            regionIso = kuorumUser.get('personalData').get('provinceCode')
	        regionIso3166_2Length = regionIso.length()
        }

		if (kuorumUser.get('professionalDetails') != null && kuorumUser.get('professionalDetails').get('region') != null){
            regionName = kuorumUser.get('professionalDetails').get('region').get('name')
            regionIso = kuorumUser.get('professionalDetails').get('region').get('iso3166_2')
	        regionIso3166_2Length = regionIso.length()
        }

        if (kuorumUser.get('professionalDetails') != null && kuorumUser.get('professionalDetails').get('constituency') != null){
            //regionName = kuorumUser.get('professionalDetails').get('constituency').get('name')
            constituencyIso = kuorumUser.get('professionalDetails').get('constituency').get('iso3166_2')
	        constituencyIsoLength = constituencyIso.length()
        }

 		kuorumUser.put('regionName', regionName);
		kuorumUser.put('regionIso3166_2', regionIso.replace('-', ''));
		kuorumUser.put('regionIso3166_2Length', regionIso3166_2Length);
		kuorumUser.put('constituencyIso3166_2', constituencyIso.replace('-', ''));
		kuorumUser.put('constituencyIso3166_2Length', constituencyIsoLength);
	}
        ]]></script>
</dataConfig>
