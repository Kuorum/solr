<?xml version="1.0" encoding="UTF-8" ?>
<dataConfig>
    <dataSource name="KuorumMongo"
                type="MongoDataSource"
                database="Kuorum"
                host="localhost"
                port="27017"/>

    <dataSource name="kuorumDDBB"
                type="JdbcDataSource"
                driver="com.mysql.jdbc.Driver"
                url="jdbc:mysql://localhost:3306/kuorum"
                user="kuorum"
                password="kuorumDBPass"/>

    <propertyWriter dateFormat="yyyy-MM-dd'T'HH:mm:ss.SSS'Z'" type="SimplePropertiesWriter" />

    <document name="kuorum">

        <entity name="kuorumUser"
                processor="MongoEntityProcessor"
                query="{'authorities.authority':{$ne:'ROLE_INCOMPLETE_USER'}, alias:{$exists:1}}"
		        deltaImportQuery="{'_id':{$oid:'${dih.delta._id}'}}"
                deltaQuery="{lastUpdated:{$gt:{$date:'${dih.last_index_time}'}}} "
                collection="kuorumUser"
                dataSource="KuorumMongo"
                transformer="script:transformKuorumUser" >
        </entity>

        <entity name="debate"
                pk="id"
                query="select CONCAT('debate_',d.id) as id,d.body as body,'DEBATE' as type, d.photoUrl as urlImage, d.datePublished as datePublished,d.title as title, cu.name as ownerName, cu.mongoId as ownerId from DEBATE d join CRM_USER cu on d.crmUser_id = cu.id where d.datePublished &lt; NOW()"
                deltaImportQuery="SELECT CONCAT('debate_',d.id) as id,d.body as body,'DEBATE' as type, d.photoUrl as urlImage, d.datePublished as datePublished,d.title as title, cu.name as ownerName, cu.mongoId as ownerId from DEBATE d join CRM_USER cu on d.crmUser_id = cu.id where d.id='${dih.delta.id}'"
                deltaQuery="select id from DEBATE where datePublished &gt; '${dih.last_index_time}' and datePublished &lt; NOW()"
                dataSource="kuorumDDBB"
                processor="SqlEntityProcessor"
                >
            <field column="id" name="id"/>
            <field column="title" name="name"/>
            <field column="ownerName" name="owner"/>
            <field column="ownerId" name="ownerId"/>
            <field column="type" name="type"/>
            <field column="datePublished" name="dateCreated"/>
            <!--<field column="alias" name="name"/>-->
            <field column="urlImage" name="urlImage"/>
            <field column="body" name="text"/>
            <!--<field column="kuorumRelevance" name="name"/>-->

        </entity>


        <entity name="post"
                pk="id"
                query="select CONCAT('post_',p.id) as id,p.body as body,'POST' as type, p.photoUrl as urlImage, p.datePublished as datePublished,p.title as title, cu.name as ownerName, cu.mongoId as ownerId from POST p join CRM_USER cu on p.crmUser_id = cu.id where p.datePublished &lt; NOW()"
                deltaImportQuery="select CONCAT('post_',p.id) as id,p.body as body,'POST' as type, p.photoUrl as urlImage, p.datePublished as datePublished,p.title as title, cu.name as ownerName, cu.mongoId as ownerId from POST p join CRM_USER cu on p.crmUser_id = cu.id where p.id='${dih.delta.id}'"
                deltaQuery="select id from POST where datePublished &gt; '${dih.last_index_time}' and datePublished &lt; NOW()"
                dataSource="kuorumDDBB"
                processor="SqlEntityProcessor"
                >
            <field column="id" name="id"/>
            <field column="title" name="name"/>
            <field column="ownerName" name="owner"/>
            <field column="ownerId" name="ownerId"/>
            <field column="type" name="type"/>
            <field column="datePublished" name="dateCreated"/>
            <!--<field column="alias" name="name"/>-->
            <field column="urlImage" name="urlImage"/>
            <field column="body" name="text"/>
            <!--<field column="kuorumRelevance" name="name"/>-->

        </entity>
    </document>

<script><![CDATA[
        function transformKuorumUser(row){
            row.put('id', row.get('_id'));
            row.put('name', getFullName(row));
            row.put('type', "KUORUM_USER");
            row.put('dateCreated', row.get('dateCreated'));
	        row.put('alias', row.get('alias'));
	        getTags(row);
            getRegionNameFromUser(row);
            getAvatar(row);
            getRole(row);
            getGender(row);
            getPoliticianInfo(row);
            row.put('text', row.get('bio'));
            row.put('kuorumRelevance', row.get('relevance'));
            return row;
        }

    function getFullName(kuorumUser){
        var fullName = kuorumUser.get('name');
        if (kuorumUser.get('surname') != null){
            var fullName = kuorumUser.get('name') +' '+ kuorumUser.get('surname');
        }
        fullName = fullName.trim();
        return fullName;
    }

    function getPoliticianInfo(kuorumUser){
        var professionalDetailsField = "professionalDetails";
        if (kuorumUser.get(professionalDetailsField) !=null){
            var politicalPartyName = kuorumUser.get(professionalDetailsField).get('politicalParty')
            if (politicalPartyName!= null){kuorumUser.put('politicalPartyName',politicalPartyName)}
		}
    }

	function getTags(kuorumUser){
		if (kuorumUser.get('ideology') !=null && kuorumUser.get('ideology').get('defendedCauses')){
			kuorumUser.put('tags',kuorumUser.get('ideology').get('defendedCauses'))
		}else{
			kuorumUser.put('tags',[])
		}
	}

        function getRole(kuorumUser){
            if (kuorumUser.get('gamification') != null && kuorumUser.get('gamification').get('activeRole')!= null){
                kuorumUser.put('role',kuorumUser.get('gamification').get('activeRole'))
            }else{
                kuorumUser.put('role','ROLE_DEFAULT')
            }
        }
        function getGender(kuorumUser){
            if (kuorumUser.get('personalData') != null && kuorumUser.get('personalData').get('gender') != null){
                kuorumUser.put("gender", kuorumUser.get('personalData').get('gender'));
            }else{
                kuorumUser.put("gender", "FEMALE");
            }
        }

        function getAvatar(kuorumUser){
            if (kuorumUser.get('avatar') != null){
                kuorumUser.put("urlImage",kuorumUser.get('avatar').get('url'));
            }
        }
	function getRegionNameFromUser(kuorumUser){
		var regionName ="";
		var regionIso = "";
		var regionIso3166_2Length = 0;

		var constituencyIso = "";
		var constituencyIsoLength = 0;
		if (kuorumUser.get('personalData') == null || kuorumUser.get('personalData').get('province') == null){
            //Usuarios de antigua web que se indexen
            regionName = "Unknown"
            regionIso = "NoValid"
	        regionIso3166_2Length = 0
        }else{
            regionName = kuorumUser.get('personalData').get('province')
            regionIso = kuorumUser.get('personalData').get('provinceCode')
	        regionIso3166_2Length = regionIso.length()
        }

		if (kuorumUser.get('professionalDetails') != null && kuorumUser.get('professionalDetails').get('region') != null){
            regionName = kuorumUser.get('professionalDetails').get('region').get('name')
            regionIso = kuorumUser.get('professionalDetails').get('region').get('iso3166_2')
	        regionIso3166_2Length = regionIso.length()
        }

        if (kuorumUser.get('professionalDetails') != null && kuorumUser.get('professionalDetails').get('constituency') != null){
            //regionName = kuorumUser.get('professionalDetails').get('constituency').get('name')
            constituencyIso = kuorumUser.get('professionalDetails').get('constituency').get('iso3166_2')
	        constituencyIsoLength = constituencyIso.length()
        }

 		kuorumUser.put('regionName', regionName);
		kuorumUser.put('regionIso3166_2', regionIso.replace('-', ''));
		kuorumUser.put('regionIso3166_2Length', regionIso3166_2Length);
		kuorumUser.put('constituencyIso3166_2', constituencyIso.replace('-', ''));
		kuorumUser.put('constituencyIso3166_2Length', constituencyIsoLength);
	}
        ]]></script>
</dataConfig>
